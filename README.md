#  USBカメラ変換基板
#  Usb_Camera_Converter 
This board with PIC32MZ is a converter that captures from a UVC(Usb Video Class) standard Usb camera and converts it to a BMP or JPG image.

 <img src="https://github.com/meerstern/Usb_Camera_Converter/blob/main/IMG/img1.JPG" width="360">
 <img src="https://github.com/meerstern/Usb_Camera_Converter/blob/main/IMG/img2.JPG" width="360">
 <img src="https://github.com/meerstern/Usb_Camera_Converter/blob/main/IMG/img6.gif" width="360">
  
## 概要
  * 本変換基板はUVC規格のUsbカメラからキャプチャしてBMPもしくはJPG画像に変換する基板です  
  * シリアルUARTコマンドもしくは基板上のボタンを押すことで画像ファイルとして記録されます  
  * インターバル設定をすることで設定した秒数間隔(1秒~最長6か月程度)で自動的にインターバル記録できます  
  * 変換した画像はTFカード(microSD互換)もしくはXmodem、Ymodemでマイコン等に転送できます  
  * 時刻管理(RTC)を内蔵しており、自動的に日付のフォルダを生成し、日付日時のファイル名で保存されます  
  * 保存可能なファイル形式(BMP/JPG)および解像度は接続するUsbカメラによって異なります
  * PCを介したシリアルコンソール上でインターバル設定やファイル形式、解像度等の設定が可能です  
  * 高フレームレートを要求しない、簡易的な記録や監視に適しています  
  
## 仕様
  * 電源電圧5V、電流800mA(microUSBもしくはピンヘッダから供給)以上の電源  
  * 時刻管理用電池CR1220搭載  
  * PIC32MZ USB HighSpeed(480MHz) Host機能によるUVCホスト(USBタイプA)  
  * PCを介したシリアルコンソール上から変更できるパラメータ:  
  記録インターバル、ファイル形式、画像解像度、日付時刻、  
  代替インタフェース設定、データフレームインターバル  
  * microTFカード対応(microSD、microSDHC、microSDXC互換)、128GBまで動作確認済  
  * 3色状態表示LED(青:電源、緑:ストリーミング中、赤:ストリーミングエラー)  
  * シリアルコンソールボーレート9600bps、データサイズ8bit、パリティ無、ストップ1bitが既定値です  
  * シリアルコンソール用のUsbドライバ(PL2303GL)は[Windows版][2]、[Mac版][3]して使用してください  
  * Linux版のシリアルコンソール用のUsbドライバはKernel 2.4.31以降、標準で組み込まれています  
  * microTFカードを介したファームウェアアップデート対応  
  * 各設定パラメータ情報は時刻と一緒に保持されます  
  * 基板サイズ25mm x65mm、穴M3x4(間隔19mm x43mm)  

 <img src="https://github.com/meerstern/Usb_Camera_Converter/blob/main/IMG/img3.JPG" width="560">
 <img src="https://github.com/meerstern/Usb_Camera_Converter/blob/main/IMG/img4.JPG" width="560">

## シリアルコンソール
  * インタラクティブなシリアルコンソールから各種設定を変更することができます  
  * ボーレート9600bps、データサイズ8bit、パリティ無、ストップ1bitが既定値です  
  * 日時コマンド一覧は下記の通りです  
  
| コマンド名 | コマンド | 引数 | 例 | 
|:-----------|:------------|:------------|:------------|
| 時刻設定 | tim= | hhmmss | tim=220212(Enterキー) |
| 時刻確認 | tim? | なし | tim?(Enterキー) |
| 日時設定 |	day= | YYMMDD | day=220305(Enterキー) | 
| 日時確認 |	day? | なし | day?(Enterキー) | 	

  * カメラ機能コマンド一覧は下記の通りです  

| コマンド名 | コマンド | 引数 | 例 | 
|:-----------|:------------|:------------|:------------|
| 条件取得 | dsps | なし | dsps(Enterキー) |
| 条件設定 | idx= | インデックス番号 | idx=12(Enterキー) |
|　条件確認 | idx? | なし | idx?(Enterキー) | 
|　画像取得(TFカード) | trg! | なし | trg!(Enterキー) | 
|　画像取得(xmodem) | xmd! | なし | xmd!(Enterキー) | 
|　画像取得(ymodem) | ymd! | なし | ymd!(Enterキー) | 
| インターバル設定 | int= | 秒数 | int=5(Enterキー) | 	
| インターバル確認 | int? | なし | int?(Enterキー) | 	
| 代替インタフェース設定 | alt= | インデックス番号 | alt=2(Enterキー) | 	
| 代替インタフェース確認 | alt? | なし | alt?(Enterキー) | 	
| データフレームインターバル設定 | dfi= | インデックス番号 | dfi=2(Enterキー) | 	
| データフレームインターバル確認 | dfi? | なし | dfi?(Enterキー) | 

  * インターバル記録しない場合はint=-1を設定します  
  * 代替インタフェース設定を自動にする場合はalt=0を設定します(既定値)  
  * 代替インタフェースは1回のデータ転送のサイズを決定します  
  * 1回のデータ転送サイズが小さすぎる場合は画像フレームのタイミングに間に合わない可能性があります  
  * 1回のデータ転送サイズが大きすぎる場合は処理しきれない場合があります  
  * カメラの機種によって設定可能な代替インタフェース数やサイズが異なります  
  
  
	
  * データフレームインターバルを自動にする場合はdfi=0を設定します(既定値)  
  * データフレームインターバルはデータ転送の間隔、カメラのフレームレートを決定します  
  * データフレームインターバルが短かすぎる場合、処理が間に合わない可能性があります  
  * データフレームインターバルが長すぎる場合、トリガを掛けてから保存されるまで時間を要する場合があります  
  * カメラの機種によって対応するデータフレームインターバルの数や大きさが異なります  
  
  * システム機能のコマンド一覧は下記の通りです  
  
| コマンド名 | コマンド | 引数 | 例 | 
|:-----------|:------------|:------------|:------------|
| ボーレート設定 | brt= | ボーレート | brt=9600(Enterキー) |
| ボーレート確認 | brt? | なし | brt?(Enterキー) |
| ソフトリセット |	rst! | なし | rst!(Enterキー) | 
| 一時停止 |	pus! | なし | pus?(Enterキー) | 	  
| 再開 |	rsm! | なし | rsm?(Enterキー) |
| ファームアップデート |	fup! | なし | fup?(Enterキー) |
| ヘルプ確認 |	help | なし | help(Enterキー) |


 <img src="https://github.com/meerstern/Usb_Camera_Converter/blob/main/IMG/img5.JPG" width="560">

## 使い方  
### a.単体で使用する場合  
  1. 本変換基板のmicroUSBをPC等に接続し、Teraterm等からシリアルコンソールにアクセスします    
  2. Usbカメラを変換基板のUsbコネクタに接続します
  3. 初期設定状態で動作開始します(初期設定ではエラーメッセージが出る場合があります)
  4. dspsコマンドで設定可能な条件を表示します  
  5. 設定したいファイル形式、解像度の条件をインデックス番号でidxコマンドを用いて設定します  
  6. rst!コマンドでソフトリセットさせて設定した内容を反映させます  
  7. microTFカードを挿入します
  8. ストリーミング中を示す緑ランプが点灯したことを確認します 点灯しない場合は5.で別の番号を設定します  
  9. trg!コマンドもしくはボタンを押すと画像が保存されます    
  
### b.連携して使用する場合    
  1. 事前にPC等からa.の設定したいファイル形式、解像度の条件を設定します
  2. 本変換基板の外部電源に5Vを供給し、TX、RXをマイコン等に接続します    
  3. Usbカメラを変換基板のUsbコネクタに接続します
  4. microTFカードを挿入します
  5. ストリーミング中を示す緑ランプが点灯したことを確認します  
  6. trg!コマンドもしくはtrgピンをGNDに接続することで画像が保存されます  
  7. xmd!コマンドを送信後、xmodem(チェックサム有効)で受信できます  
  8. ymd!コマンドを送信後、ymodemで受信できます   
  9. ユーザ側でコードを実装することでSPI等を介して外部機器と通信できます  
  
### c.日付/時刻設定する場合
  1. 本変換基板のmicroUSBをPC等に接続し、Teraterm等からシリアルコンソールにアクセスします   
  2. day=コマンドで日付を設定します 例 22年3月14日の場合はday=220314(Enter)と入力します  
  3. tim=コマンドで時刻を設定します 例 午後1時23分34秒の場合はtim=132334(Enter)と入力します  
  4. day?コマンド、tim?コマンドで設定された日付、日時を確認します  　
  
   * 日付、時刻が1桁の場合は0で桁を埋めてください 

### d.ファームウェアアップデートする場合
  1. アップデートしたいファームウェアをTFカードのディレクトリ直下にいれます  
  2. ファイル名をimage.binに変更します  
  3. 変換基板にTFカードを挿入し、電源を供給します  
  4. Teraterm等からシリアルコンソールからfup!コマンドを実行します  
  5. 自動的に再起動し、ファームウェアアップデートが開始されます  
  6. Update Successを確認するかシリアルコンソールに表示されるバージョンを確認してください  
  

## 注意点
  * マイコン上で処理する都合上、完全なUVC規格でありません  
  * カメラによって動作しないor不安定な場合があります  
  * 動作確認済のUsbカメラはTestedCamera.csvをご確認ください  
  * ハイビジョン対応等の高機能カメラよりも200万画素程度の単機能カメラの方が安定して動く傾向があります  
  * 動画を切り出して画像に変換するため、最高でも1FPSです 高フレームレートを要求する用途には適しません  
  * ボタンやコマンドから取得命令後、ストリーミングデータから切り出し処理の都合上、タイムラグがあります  
  * BMP形式の場合、メモリの制約によって最大解像度は320x240です  
  * JPG形式の場合、解像度によって動作、非動作の場合があります  
  * 動画ファイル形式の記録はできません  
  * 電源不安定や電流が足りない場合、動作確認済のカメラであっても正常に動作しない場合があります  
  * 電流が足りない場合、microUSBとJ5 5Vピンの両方から5V電源を供給することで動作する場合があります  
  * フォーマット、解像度のインデックス番号はカメラ機種によって番号や設定可能な条件数が異なります  
  * カメラによってはBMPをサポートしていないカメラがあります  
  * モードによって動作しない場合、下記の設定を変更することで動作する場合があります  
   -代替インタフェース設定(altコマンド)  
   -データフレームインターバル設定(dfiコマンド) 
  * 設定を変更することで必ず動作できる保証はありません   
  * Xmodem/Ymodemによる転送は9600bpsの場合、1枚の画像で数10分前後転送に要します  
  * 各設定はソフトリセット後もしくは電源再投入後に反映されます  
  * 時刻管理電池の消耗や交換した場合、各設定パラメータ、時刻はリセットされます  
  * ファームウェアアップデート時はボーレート9600bpsで固定です   

## ファームウェアビルド方法
  * MPLAB X v5.45/XC32 v2.50/Harmoney3以降を用いてビルドしてください  
  * ブートローダ用のAppファームをビルドする際はリンカファイルにp32MZ2048EFG100withBOOTLD.ldを選択します  
  * 生成されたAppファームの*.binファイルをimage.binに変更してSDカードから更新コマンドを用いて更新してください    
  * デバッグ等でブートローダ未使用でファームをビルドする際はリンカファイルにp32MZ2048EFG100.ldを選択します  
  * 再度、ブートローダを書き込む際にはUsbCamBoot_v.XX_XXXXXX.hexをIPE等から書き込んでください  
  
## 応用編
  * LCDファームに書き換えることでSPI対応LCD(160x128、ST7735S)でモニタすることが可能です  
  * LCDモニタはBMPの場合、160x120解像度のみ対応しています    
  * ENABLE_JPGDECODEを有効化することでTJPGD3ライブラリを用いてJPGからBMPにデコードして描画できます    
  　解像度幅160、320、640、1280のみ、一部のカメラは未対応  
  * コードを公開しています 改造することで他の機器とすることが可能です  
  * UART(XMODEM/YMODEM)に比べてSPIを介して高速に転送できます  

| LCDピン | 変換基板ピン |  
|:-----------|:------------|
| VCC,LED | J7 3.3V | 
| GND | J7 GND | 
| CS |	J7 CS | 
| SCK |	J7 SCK |   
| SDA |	J7 MOSI | 
| AO |	J3 PGED | 
| RST |	J3 PGEC | 




[2]: http://www.prolific.com.tw/US/ShowProduct.aspx?p_id=225&pcid=41
[3]: http://www.prolific.com.tw/US/ShowProduct.aspx?p_id=229&pcid=41
